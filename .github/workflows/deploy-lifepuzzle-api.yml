name: Deploy to Production (lifepuzzle-api)

on:
  workflow_dispatch:

defaults:
  run:
    working-directory: apps/backend

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'corretto'

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Build with Gradle
        run: ./gradlew clean build
        env: ${{ secrets }}

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v6
        with:
          context: apps/backend
          file: apps/backend/services/lifepuzzle-api/Dockerfile
          push: true
          tags: ghcr.io/itmca/lifepuzzle-api:latest

      - name: SSH into Home Server and Deploy
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: ${{ secrets.HOME_SERVER_HOST }}
          username: ${{ secrets.HOME_SERVER_USER }}
          key: ${{ secrets.HOME_SERVER_SSH_KEY }}
          port: 2022
          script: |
            echo "Updating K8s Secret and restarting deployment..."
            /opt/homebrew/bin/kubectl config use-context colima-prod

            # Create/update secret with all environment variables
            /opt/homebrew/bin/kubectl -n app create secret generic lifepuzzle-secret \
              --from-literal=DB_PROD_URL='${{ secrets.DB_PROD_URL }}' \
              --from-literal=DB_PROD_USERNAME='${{ secrets.DB_PROD_USERNAME }}' \
              --from-literal=DB_PROD_PASSWORD='${{ secrets.DB_PROD_PASSWORD }}' \
              --from-literal=RABBITMQ_HOST='lifepuzzle-rabbitmq' \
              --from-literal=RABBITMQ_PORT='5672' \
              --from-literal=RABBITMQ_USERNAME='${{ secrets.RABBITMQ_USERNAME }}' \
              --from-literal=RABBITMQ_PASSWORD='${{ secrets.RABBITMQ_PASSWORD }}' \
              --from-literal=MAIL_HOST='smtp.gmail.com' \
              --from-literal=MAIL_PORT='587' \
              --from-literal=MAIL_USERNAME='${{ secrets.MAIL_USERNAME }}' \
              --from-literal=MAIL_PASSWORD='${{ secrets.MAIL_PASSWORD }}' \
              --from-literal=AWS_ACCESS_KEY='${{ secrets.AWS_ACCESS_KEY }}' \
              --from-literal=AWS_SECRET_KEY='${{ secrets.AWS_SECRET_KEY }}' \
              --from-literal=AWS_S3_BUCKET='${{ secrets.AWS_S3_BUCKET }}' \
              --from-literal=AWS_REGION='${{ secrets.AWS_REGION }}' \
              --from-literal=SENTRY_DSN='${{ secrets.SENTRY_DSN }}' \
              --from-literal=SLACK_WEBHOOK_URL='${{ secrets.SLACK_WEBHOOK_URL }}' \
              --from-literal=APPLE_TEAM_ID='${{ secrets.APPLE_TEAM_ID }}' \
              --from-literal=APPLE_BUNDLE_ID='${{ secrets.APPLE_BUNDLE_ID }}' \
              --from-literal=APPLE_PRIVATE_KEY_ID='${{ secrets.APPLE_PRIVATE_KEY_ID }}' \
              --from-literal=APPLE_PRIVATE_KEY='${{ secrets.APPLE_PRIVATE_KEY }}' \
              --from-literal=S3_SERVER_HOST='${{ secrets.S3_SERVER_HOST }}' \
              --dry-run=client -o yaml | /opt/homebrew/bin/kubectl apply -f -

            # Restart deployment to pick up new image and secrets
            /opt/homebrew/bin/kubectl -n app rollout restart deployment/lifepuzzle
            /opt/homebrew/bin/kubectl -n app rollout status deployment/lifepuzzle
