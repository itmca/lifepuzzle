name: PR Title Check

on:
  pull_request:
    types: [opened, edited, synchronize, reopened, ready_for_review]

jobs:
  check-pr-title:
    runs-on: ubuntu-latest
    steps:
      - name: Validate PR title (Chris Beams Style)
        uses: actions/github-script@v8
        with:
          script: |
            const title = context.payload.pull_request.title;

            // Extract title without optional prefixes
            const titleWithoutPrefix = title.replace(/^(\[(SHIP|SHOW|ASK)\])?(\[LP-\d+\])?\s*/, '');

            // Check if starts with capital letter
            const startsWithCapital = /^[A-Z]/.test(titleWithoutPrefix);

            // Check length: 50 recommended, 72 hard limit
            const isRecommendedLength = title.length <= 50;
            const isWithinHardLimit = title.length <= 72;

            // Check no period at the end
            const hasNoPeriod = !title.endsWith('.');

            // Check imperative mood (starts with verb)
            const commonVerbs = /^(Add|Fix|Update|Remove|Refactor|Implement|Create|Delete|Change|Move|Rename|Improve|Optimize|Support|Enable|Disable|Handle|Prevent|Allow|Merge|Revert|Bump|Upgrade|Downgrade|Migrate|Extract|Simplify|Clean|Normalize|Validate|Configure|Setup|Initialize|Integrate)/i;
            const isImperative = commonVerbs.test(titleWithoutPrefix);

            let hasError = false;
            let hasWarning = false;
            let message = '';

            if (!startsWithCapital) {
              hasError = true;
              message += `❌ 제목은 대문자로 시작해야 합니다.\n`;
            }

            if (!isWithinHardLimit) {
              hasError = true;
              message += `❌ 제목이 너무 깁니다 (${title.length}자). 72자 이내로 작성해주세요.\n`;
            } else if (!isRecommendedLength) {
              hasWarning = true;
              message += `⚠️ 제목이 권장 길이를 초과했습니다 (${title.length}자). 50자 이내를 권장합니다.\n`;
            }

            if (!hasNoPeriod) {
              hasError = true;
              message += `❌ 제목 끝에 마침표를 사용하면 안됩니다.\n`;
            }

            if (!isImperative && !hasError) {
              hasWarning = true;
              message += `⚠️ 명령형 동사로 시작하는 것을 권장합니다 (Add, Fix, Update 등).\n`;
            }

            if (hasError || hasWarning) {
              console.log(`PR 제목: "${title}" (${title.length}자)\n`);
              console.log(message);
              console.log(`
            Chris Beams 스타일 규칙:
              - 명령형으로 작성 (Add, Fix, Update 등)
              - 첫 글자 대문자
              - 50자 이내 권장, 72자 하드 리밋
              - 마지막에 마침표 없음

            올바른 예시:
              ✅ Add user authentication feature
              ✅ Fix memory leak in image processor
              ✅ [LP-1234] Update API documentation
              ✅ [SHIP][LP-5678] Implement photo upload with progress indicator
              `);

              if (hasError) {
                core.setFailed(message);
              }
            } else {
              console.log(`✅ PR 제목이 Chris Beams 스타일을 따릅니다: "${title}" (${title.length}자)`);
            }
