name: Deploy to Production (ai-video-generator)

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    
    permissions: 
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'corretto'

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew
        shell: bash

      - name: Build with Gradle
        run: ./gradlew clean build

      - name: Get current time
        uses: josStorer/get-current-time@v2.1.2
        id: current-time
        with:
          format: YYYY-MM-DDTHH-mm-ss
          utcOffset: "+09:00"

      - name: Set artifact
        run: echo "artifact=$(ls ./services/ai-video-generator/build/libs/*.jar)" >> $GITHUB_ENV

      - name: Upload and Deploy JAR file
        run: |
          # Setup SSH key
          mkdir -p ~/.ssh
          echo "${{ secrets.HOME_SERVER_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Add host to known_hosts
          ssh-keyscan -p ${{ secrets.HOME_SERVER_PORT }} -H ${{ secrets.HOME_SERVER_HOST }} >> ~/.ssh/known_hosts
          
          # Upload JAR file
          echo "Uploading JAR file..."
          scp -i ~/.ssh/deploy_key -P ${{ secrets.HOME_SERVER_PORT }} \
            ${{ env.artifact }} \
            ${{ secrets.HOME_SERVER_USER }}@${{ secrets.HOME_SERVER_HOST }}:/tmp/ai-video-generator.jar
          
          echo "JAR file uploaded successfully"

      - name: SSH into Home Server and Deploy Application
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOME_SERVER_HOST }}
          username: ${{ secrets.HOME_SERVER_USER }}
          key: ${{ secrets.HOME_SERVER_SSH_KEY }}
          port: ${{ secrets.HOME_SERVER_PORT }}
          script: |
            echo "Deploying ai-video-generator..."
            
            # Create application directories in user space
            mkdir -p $HOME/lifepuzzle/ai-video-generator
            mkdir -p $HOME/lifepuzzle/logs
            mkdir -p $HOME/lifepuzzle/tmp/ai_video
            
            # Create symlinks for compatibility if needed
            if [ ! -d "/opt/lifepuzzle" ] && [ -w "/opt" ]; then
              mkdir -p /opt/lifepuzzle/ai-video-generator
              mkdir -p /var/log/lifepuzzle
              mkdir -p /var/tmp/ai_video
            elif [ ! -w "/opt" ]; then
              echo "Warning: /opt not writable, using home directory"
              # Use home directory paths
              export LIFEPUZZLE_HOME="$HOME/lifepuzzle"
              export LOG_PATH="$HOME/lifepuzzle/logs"
              export TMP_PATH="$HOME/lifepuzzle/tmp/ai_video"
            fi
            
            # Determine deployment directory
            if [ -w "/opt/lifepuzzle/ai-video-generator" ]; then
              DEPLOY_DIR="/opt/lifepuzzle/ai-video-generator"
              LOG_DIR="/var/log/lifepuzzle"
            else
              DEPLOY_DIR="$HOME/lifepuzzle/ai-video-generator"
              LOG_DIR="$HOME/lifepuzzle/logs"
            fi
            
            echo "Using deployment directory: $DEPLOY_DIR"
            echo "Using log directory: $LOG_DIR"
            
            # Set up JAR file from uploaded location
            cd "$DEPLOY_DIR"
            rm -f ai-video-generator.jar
            mv /tmp/ai-video-generator.jar ai-video-generator.jar
            chmod +x ai-video-generator.jar
            echo "JAR file deployed: $(ls -la ai-video-generator.jar)"
            
            # Create environment file for application startup
            cat > "$DEPLOY_DIR/app.env" <<ENV_EOF
            DB_PROD_URL=${{ secrets.DB_PROD_URL }}
            DB_PROD_USERNAME=${{ secrets.DB_PROD_USERNAME }}
            DB_PROD_PASSWORD=${{ secrets.DB_PROD_PASSWORD }}
            RABBITMQ_HOST=${{ secrets.RABBITMQ_EXTERNAL_HOST }}
            RABBITMQ_PORT=${{ secrets.RABBITMQ_PORT }}
            RABBITMQ_USERNAME=${{ secrets.RABBITMQ_USERNAME }}
            RABBITMQ_PASSWORD=${{ secrets.RABBITMQ_PASSWORD }}
            AWS_ACCESS_KEY=${{ secrets.AWS_ACCESS_KEY }}
            AWS_SECRET_KEY=${{ secrets.AWS_SECRET_KEY }}
            AWS_S3_BUCKET=${{ secrets.AWS_S3_BUCKET }}
            AWS_REGION=${{ secrets.AWS_REGION }}
            AI_VIDEO_OUTPUT_PATH=${{ secrets.AI_VIDEO_OUTPUT_PATH }}
            AI_VIDEO_DOWNLOAD_PATH=${{ secrets.AI_VIDEO_DOWNLOAD_PATH }}
            AI_VIDEO_CONDA_ENV=${{ secrets.AI_VIDEO_CONDA_ENV }}
            AI_VIDEO_PROJECT_PATH=${{ secrets.AI_VIDEO_PROJECT_PATH }}
            SERVER_PORT=9001
            ENV_EOF
            
            # Set secure permissions for environment file
            chmod 600 "$DEPLOY_DIR/app.env"
            
            # Create simple startup script
            cat > "$DEPLOY_DIR/start.sh" <<SCRIPT_EOF
            #!/bin/bash
            cd "$DEPLOY_DIR"
            
            # Load environment variables and export them
            set -a  # automatically export all variables
            source ./app.env
            set +a  # stop automatically exporting
            
            nohup java -jar -Xmx2g -Dspring.profiles.active=prod ai-video-generator.jar > "$LOG_DIR/ai-video-generator.log" 2>&1 &
            echo \$! > ai-video-generator.pid
            echo "AI Video Generator started with PID \$(cat ai-video-generator.pid)"
            SCRIPT_EOF
            
            chmod +x "$DEPLOY_DIR/start.sh"
            
            # Stop existing process if running
            if [ -f "$DEPLOY_DIR/ai-video-generator.pid" ]; then
              OLD_PID=$(cat "$DEPLOY_DIR/ai-video-generator.pid")
              if ps -p $OLD_PID > /dev/null 2>&1; then
                echo "Stopping existing process (PID: $OLD_PID)"
                kill $OLD_PID
                sleep 5
              fi
              rm -f "$DEPLOY_DIR/ai-video-generator.pid"
            fi
            
            # Start the application
            echo "Starting AI Video Generator..."
            "$DEPLOY_DIR/start.sh"
            
            # Wait for application to start
            sleep 10
            
            # Check deployment status
            echo "=== Deployment Status ==="
            if [ -f "$DEPLOY_DIR/ai-video-generator.pid" ]; then
              PID=$(cat "$DEPLOY_DIR/ai-video-generator.pid")
              if ps -p $PID > /dev/null 2>&1; then
                echo "✅ Application is running (PID: $PID)"
              else
                echo "❌ Application failed to start"
              fi
            else
              echo "❌ PID file not found"
            fi
            
            echo "=== Port Check ==="
            lsof -i :9001 || echo "Port 9001 not yet bound"
            
            echo "=== Recent Logs ==="
            tail -n 10 "$LOG_DIR/ai-video-generator.log" 2>/dev/null || echo "No logs yet"
            
            echo "=== Files Summary ==="
            echo "JAR: $(ls -la $DEPLOY_DIR/*.jar 2>/dev/null || echo 'Not found')"
            echo "ENV: $(ls -la $DEPLOY_DIR/app.env 2>/dev/null || echo 'Not found')"
            echo "PID: $(ls -la $DEPLOY_DIR/*.pid 2>/dev/null || echo 'Not found')"
            echo "Deploy Dir: $DEPLOY_DIR"
            echo "Log Dir: $LOG_DIR"
            
            echo "Deployment completed!"
